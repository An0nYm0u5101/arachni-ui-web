<% treat_as_running = local_assigns[:treat_as_running].nil? ? true : false %>

<%
   show_aborted_legend = false
   show_error_legend   = false

   type = (treat_as_running ? 'active' : 'finished')
   filter = "filter_#{type}"
   opts = params.merge( format: :js )
%>

<ul class="nav nav-tabs" id="scan-table-tab"
    data-table-container="<%= type %>-table-container">
    <li
        <% if params[filter] == 'yours' %>
           class="active"
        <% end %>
        >

        <%= link_to 'Yours', scans_url( opts.merge( filter => 'yours' ) ),
                    onclick: 'scanTableLoading();', remote: true %>
    </li>
    <li
    <% if params[filter] == 'shared' %>
    class="active"
    <% end %>
    >
        <%= link_to 'Shared', scans_url( opts.merge( filter => 'shared' ) ),
                    onclick: 'scanTableLoading();', remote: true %>
    </li>

    <% if current_user.admin? %>
        <li
        <% if params[filter] == 'others' %>
        class="active"
        <% end %>
        >
            <%= link_to 'Others', scans_url( opts.merge( filter => 'others' ) ),
                        onclick: 'scanTableLoading();', remote: true %>
        </li>
    <% end %>
</ul>

<% if scans.any? %>

<div id="<%= type %>-table-container">
    <table class="table table-striped table-hover table-condensed">
        <thead>
        <tr>
            <th>URL</th>
            <th>Profile</th>
            <th class="hidden-phone">Type</th>

            <% if treat_as_running %>
            <th>Status</th>
            <th>Progress</th>
            <% end %>

            <th>Issue count</th>

            <% if treat_as_running %>
            <th class="hidden-phone">Sitemap size</th>
            <th class="hidden-phone">Running for</th>
            <th>ETA</th>
            <% else %>
            <th>Started at</th>
            <th>Finished at</th>
            <% end %>

            <th>Owner</th>
            <th class="hidden-phone">Comments</th>
            <th></th>
        </tr>
        </thead>

        <% scans.each do |scan| %>
            <tr <%= if scan.paused?
                        'class="warning" title="Scan is paused."'.html_safe
                    elsif scan.aborted?
                        show_aborted_legend = true
                        'class="warning" title="Scan was aborted."'.html_safe
                    elsif scan.error?
                        show_error_legend = true
                        'class="error" title="Scan encountered a fatal error."'.html_safe
                    end
                %>
            >
                <td><%= scan.url %></td>
                <td><%= link_to scan.profile.name, scan.profile %></td>
                <td>
                    <%= scan.type.to_s.capitalize %>
                    <% if scan.dispatcher %>
                    (<%= link_to scan.dispatcher.url, scan.dispatcher %>)
                    <% end %>
                </td>

                <% if treat_as_running %>
                <td><%= scan.status.to_s.capitalize %></td>
                <td><%= scan.progress.to_f %>%</td>
                <% end %>

                <td><%= scan.issue_count %></td>

                <% if treat_as_running %>
                <td class="hidden-phone"><%= scan.sitemap_size %></td>
                <td class="hidden-phone"><%= scan.runtime %></td>
                <td><%= scan.eta %></td>
                <% else %>
                <td><%= l scan.created_at %></td>
                <td><%= scan.finished_at ? l( scan.finished_at ) : 'N/A' %></td>
                <% end %>

                <td>
                    <% if scan.owner == current_user %>
                        <span class="label">You</span>
                    <% else %>
                        <span class="label label-info"><%= scan.owner.name %></span>
                    <% end %>
                </td>

                <td class="hidden-phone"><%= (cs = scan.comments.size) > 1 ? cs : 'None yet' %></td>

                <td>
                    <% if can? :read, scan %>
                    <%= link_to scan, title: 'Show scan', class: 'btn btn-info' do %>
                        <i class="icon-eye-open"></i>
                    <% end %>
                    <% end %>

                    <% if scan.active? %>
                        <% if can? :pause, scan %>
                            <% if scan.paused? %>
                                <%= link_to resume_scan_url( scan ), title: 'Resume scan',
                                            method: :put, class: 'btn btn-success',
                                            data: { confirm: 'Are you sure you want to resume the scan?' } do %>
                                    <i class="icon-play-circle"></i>
                                <% end %>

                            <% else %>
                                <%= link_to pause_scan_url( scan ), title: 'Pause scan',
                                            method: :put, class: 'btn btn-warning',
                                            data: { confirm: 'Are you sure you want to pause the scan?' } do %>
                                    <i class="icon-pause"></i>
                                <% end %>
                            <% end  %>
                        <% end  %>

                        <% if can? :abort, scan %>
                            <%= link_to abort_scan_url( scan ), title: 'Abort scan',
                                        method: :put, class: 'btn btn-danger',
                                        data: { confirm: 'Are you sure you want to abort the scan?' } do %>
                                <i class="icon-stop"></i>

                            <% end %>

                            <%= render partial: 'share_form', locals: { scan: scan, nolabel: true } %>

                        <% end %>
                    <% else %>
                        <% if can? :delete, scan %>
                            <%= link_to scan, title: 'Delete scan', method: :delete, class: 'btn btn-danger',
                                        data: { confirm: 'Are you sure you want to delete this scan?' } do %>
                                <i class="icon-trash"></i>
                            <% end %>
                            <%= render partial: 'share_form', locals: { scan: scan, nolabel: true } %>
                        <% end %>
                <% end %>
                </td>
            </tr>
        <% end %>
    </table>

    <% if show_aborted_legend || show_error_legend %>
        <div class="alert alert-info">
            <ul>
                <% if show_aborted_legend %>
                <li>Yellow rows indicate aborted scans.</li>
                <% end %>
                <% if show_error_legend %>
                <li>Red rows indicate scans which have stopped due to a fatal error (i.e. the scan Instance suddenly died).</li>
                <% end %>
            </ul>
        </div>
    <% end %>

</div>
    <% else %>
    <p class="alert alert-info">
        There are no such scans at the moment.
    </p>
<% end %>
