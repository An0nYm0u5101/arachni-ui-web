<% if !params.delete( :change_revision ) %>
    $("#comments-list").html( "<%= escape_javascript(
                        render partial: 'comments/list.html',
                            locals: {
                                 comments: @scan.comments,
                                 list_url: scan_comments_url( @scan, partial: true ),
                                 refresh: false
                       }).force_encoding( 'utf-8' ) %>" );
<% else %>
    $("#comments").html( "<%= escape_javascript( render partial: 'comments' ) %>" );
<% end %>

<% if params[:action].to_s == 'update' %>
    $('#editable-description' ).html( "<%= escape_javascript( render partial: 'editable_description' ) %>" );
<% else %>
    <% if @scan.overview? %>
        $('#scan-description' ).html( "Overview" );
    <% else %>
        $('#scan-description' ).html( "<%= escape_javascript( @scan.description ) %>" );
    <% end %>
<% end %>

<% if !@scan.error_messages.empty? %>
    $("#error-messages").html( "<%= escape_javascript( @scan.error_messages ).force_encoding( 'utf-8' ) %>" );

    objDiv = document.getElementById( "error_messages" );
    objDiv.scrollTop = objDiv.scrollHeight;
<% end %>

$("#scan").html( "<%= escape_javascript( render @scan.active? ? 'show_active' : 'show_inactive' ) %>" );

$("#issues").html( "<%= escape_javascript( render( partial: 'issues/table.html', locals: { url_method_type: :scan_url } ) .force_encoding( 'utf-8' ) ) %>" );

<% if @scan.active? %>
    $("#progress").html( "<%= escape_javascript( render( partial: 'progress' ).force_encoding( 'utf-8' ) ) %>" );
<% end %>

$("#revisions-nav-list").html( "<%= escape_javascript( render( partial: 'revisions_nav_list' ).force_encoding( 'utf-8' ) ) %>" );

<% if !params['_method'] || params['_method'] == 'get' %>
    $('#updater').data( 'refresh-url', "<%= scan_url( @scan, params.merge( format: :js ) ) %>" );
<% end %>

window.setupScanCallbacks();
window.setupComments();

<% if @scan.overview? %>
    $('#comments-link-container').hide();
    $('#comments').hide();
<% else %>
    $('#comments-link-container').show();
    $('#comments').show();
<% end %>
